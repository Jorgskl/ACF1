<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC F1 | Form Rankings</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="main-header">
        <nav class="navbar">
            <a href="index.html" class="nav-logo">ACF1</a>
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="results.html" class="nav-link">Results</a></li>
                <li class="nav-item"><a href="rankings.html" class="nav-link active">Power Rankings</a></li>
                <li class="nav-item"><a href="standings.html" class="nav-link">Standings</a></li>
                <li class="nav-item"><a href="news.html" class="nav-link">News</a></li>
            </ul>
        </nav>
    </header>

    <main class="rankings-main">
        <div class="rankings-container">

            <div class="movers-shakers-container">
                <div class="mover-item clickable" data-action="show-climbers">
                    <small>SEASON'S BIGGEST CLIMBER</small>
                    <div class="mover-details" id="biggest-climber">
                        <img src="" alt=""><span class="mover-name">N/A</span><span class="mover-change up"></span>
                    </div>
                </div>
                <div class="mover-item clickable" data-action="show-fallers">
                    <small>SEASON'S BIGGEST FALLER</small>
                    <div class="mover-details" id="biggest-faller">
                        <img src="" alt=""><span class="mover-name">N/A</span><span class="mover-change down"></span>
                    </div>
                </div>
            </div>

            <div class="event-selector-container">
                <button id="show-drivers-rankings-btn" class="event-tab active">Drivers</button>
                <button id="show-teams-rankings-btn" class="event-tab">Teams</button>
            </div>

             <div id="driver-rankings-view">
                <div class="rankings-header"><h1>Driver Form Rankings</h1><p>Click on a driver to see a detailed performance breakdown and their season trend.</p></div>
                <div id="driver-rankings-list" class="rankings-list"></div>
            </div>

            <div id="team-rankings-view" style="display: none;">
                <div class="rankings-header"><h1>Constructor Form Rankings</h1><p>Click on a team to see a detailed performance breakdown and their season trend.</p></div>
                <div id="team-rankings-list" class="rankings-list"></div>
            </div>

        </div>
    </main>

    <!-- TEMPLATES -->
    <template id="driver-ranking-item-template"><div class="ranking-item" data-driver-id=""><div class="rank-pos"><span class="rank-change" data-change></span><span data-rank></span></div><div class="rank-driver"><img src="" alt="" class="driver-photo-rank" data-img><span class="team-color-bar" data-team-bar></span><div><span data-name></span><small data-sub-name></small></div><div class="kpi-icons" data-kpi-icons></div></div><div class="rank-score"><div class="form-streak" data-streak></div><div class="score-bar-container"><div class="score-bar" data-score-bar></div></div><span data-score></span></div></div></template>
    <template id="team-ranking-item-template"><div class="ranking-item" data-team-id=""><div class="rank-pos"><span class="rank-change" data-change></span><span data-rank></span></div><div class="rank-driver"><img src="" alt="" class="team-logo-rank" data-img><div><span data-name></span></div></div><div class="rank-score"><div class="form-streak" data-streak></div><div class="score-bar-container"><div class="score-bar" data-score-bar></div></div><span data-score></span></div></div></template>
    <template id="cumulative-stat-item-template"><div class="cumulative-item"><div class="cumulative-pos" data-rank></div><div class="cumulative-driver"><img src="" alt="" class="driver-photo-rank" data-img><span data-name></span></div><div class="cumulative-change" data-change></div></div></template>

    <!-- MODALS -->
    <div id="details-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><button class="modal-close-btn" id="modal-close-btn-details">&times;</button><div class="modal-header"><img src="" id="modal-img" alt=""><div><h2 id="modal-name"></h2><p id="modal-sub-name"></p></div></div><div class="modal-body"><div class="modal-section"><h3>Performance Breakdown</h3><div class="score-breakdown" id="modal-score-breakdown"></div></div><div class="modal-section"><h3>Ranking Trend</h3><div class="chart-container"><canvas id="performance-chart"></canvas></div></div><div class="modal-section" id="modal-h2h-section"><h3>Head-to-Head vs Teammate</h3><div class="h2h-comparison" id="modal-h2h-comparison"></div></div></div></div></div>
    <div id="cumulative-stats-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><button class="modal-close-btn" id="modal-close-btn-cumulative">&times;</button><div class="modal-header"><h2 id="cumulative-modal-title"></h2></div><div class="modal-body" id="cumulative-modal-list"></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="database.js"></script>
    <script src="strategy.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof tournamentData === 'undefined') { console.error("Database not loaded!"); return; }

            const db = tournamentData;
            const raceEvents = db.allEvents.filter(e => e.eventType === 'race');
            const totalRaceEvents = raceEvents.length;
            let performanceChart = null;

            const positionToPoints = (pos) => { if (pos === 'NC' || pos === 'DSQ' || pos === 'DNS' || !pos) return 0; const position = parseInt(pos, 10); return Math.max(0, 100 - ((position - 1) * (100 / 19))); };
            const parseTimeToSeconds = (timeStr) => { if (typeof timeStr !== 'string') return Infinity; const parts = timeStr.split(/[:.]/); if (parts.length < 3) return Infinity; return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10) + parseInt(parts[2], 10) / 1000; };

            function calculateFormRanking(eventLimit) { const stats = {}; Object.keys(db.drivers).forEach(id => { stats[id] = { id, raceScores: [], paceScores: [], qualiScores: [], racesEntered: 0, racesFinished: 0 }; }); const eventsToProcess = raceEvents.slice(0, eventLimit); eventsToProcess.forEach(event => { let bestEventTime = Infinity; const eventTimes = new Map(); event.sessions.forEach(s => { if (s.type !== 'race') { s.results.forEach(r => { const time = parseTimeToSeconds(r.time); if (time < bestEventTime) bestEventTime = time; if (eventTimes.get(r.driverId) === undefined || time < eventTimes.get(r.driverId)) { eventTimes.set(r.driverId, time); } }); } }); Object.keys(db.drivers).forEach(driverId => { const driverTime = eventTimes.get(driverId); if (driverTime && isFinite(driverTime) && bestEventTime !== Infinity) { stats[driverId]?.paceScores.push((bestEventTime / driverTime) * 100); } }); const raceSession = event.sessions.find(s => s.type === 'race'); const qualiSession = event.sessions.find(s => s.type === 'qualifying'); raceSession?.results.forEach(r => { if (stats[r.driverId]) { stats[r.driverId].racesEntered++; if (r.pos !== 'NC') stats[r.driverId].racesFinished++; stats[r.driverId].raceScores.push(positionToPoints(r.pos)); } }); qualiSession?.results.forEach(r => { stats[r.driverId]?.qualiScores.push(positionToPoints(r.pos)); }); }); const avg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0; return Object.values(stats).map(driver => { const raceScore = avg(driver.raceScores); const paceScore = avg(driver.paceScores); const qualiScore = avg(driver.qualiScores); const reliabilityScore = driver.racesEntered > 0 ? (driver.racesFinished / driver.racesEntered) * 100 : 0; const finalScore = (raceScore * 0.40) + (paceScore * 0.30) + (qualiScore * 0.20) + (reliabilityScore * 0.10); return { ...driver, finalScore, breakdown: { race: raceScore, pace: paceScore, qualifying: qualiScore, reliability: reliabilityScore } }; }).sort((a, b) => b.finalScore - a.finalScore); }
            function calculateTeamFormRanking(driverRankings) { const teamStats = {}; Object.keys(db.teams).forEach(id => { teamStats[id] = { id, driverScores: [] }; }); driverRankings.forEach(driverData => { if (driverData.racesEntered > 0) { const driverInfo = db.drivers[driverData.id]; teamStats[driverInfo.teamId].driverScores.push(driverData.finalScore); } }); return Object.values(teamStats).map(team => { const finalScore = team.driverScores.length > 0 ? team.driverScores.reduce((a, b) => a + b, 0) / team.driverScores.length : 0; return { ...team, finalScore }; }).sort((a, b) => b.finalScore - a.finalScore); }
            function calculateHistoricalRankings(type) { const history = {}; const entities = type === 'driver' ? Object.keys(db.drivers) : Object.keys(db.teams); entities.forEach(id => { history[id] = []; }); for (let i = 1; i <= totalRaceEvents; i++) { const driverRankings = calculateFormRanking(i); const rankings = type === 'driver' ? driverRankings : calculateTeamFormRanking(driverRankings); const posMap = new Map(rankings.map((entity, index) => [entity.id, index + 1])); entities.forEach(id => history[id].push(posMap.get(id) || (type === 'driver' ? 21 : 11))); } return history; }
            
            function calculateCumulativeGains() { const cumulative = {}; Object.keys(db.drivers).forEach(id => { cumulative[id] = { id, netGain: 0 }; }); raceEvents.forEach(event => { const qualiRes = event.sessions.find(s => s.type === 'qualifying')?.results; const raceRes = event.sessions.find(s => s.type === 'race')?.results; if (!qualiRes || !raceRes) return; const startPosMap = new Map(qualiRes.map(r => [r.driverId, parseInt(r.pos)])); raceRes.forEach(result => { if (result.pos !== 'NC' && startPosMap.has(result.driverId)) { const startPos = startPosMap.get(result.driverId); const endPos = parseInt(result.pos); cumulative[result.driverId].netGain += (startPos - endPos); } }); }); return Object.values(cumulative); }

            const currentDriverRankings = calculateFormRanking(totalRaceEvents);
            const previousDriverRankings = totalRaceEvents > 1 ? calculateFormRanking(totalRaceEvents - 1) : null;
            const driverHistory = calculateHistoricalRankings('driver');
            const currentTeamRankings = calculateTeamFormRanking(currentDriverRankings);
            const previousTeamRankings = previousDriverRankings ? calculateTeamFormRanking(previousDriverRankings) : null;
            const teamHistory = calculateHistoricalRankings('team');
            const cumulativeGainsData = calculateCumulativeGains();

            function renderAll() { renderDriverList(); renderTeamList(); renderMoversShakers(); }

            function renderDriverList() { const container = document.getElementById('driver-rankings-list'); const template = document.getElementById('driver-ranking-item-template'); const prevPosMap = previousDriverRankings ? new Map(previousDriverRankings.map((d, i) => [d.id, i + 1])) : new Map(); container.innerHTML = ''; currentDriverRankings.forEach((driverData, index) => { if (driverData.racesEntered === 0) return; const driver = db.drivers[driverData.id]; const team = db.teams[driver.teamId]; const clone = template.content.cloneNode(true); const itemEl = clone.querySelector('.ranking-item'); itemEl.dataset.driverId = driverData.id; const currentPos = index + 1; const previousPos = prevPosMap.get(driverData.id) || 21; const change = previousPos - currentPos; const changeEl = clone.querySelector('[data-change]'); if (totalRaceEvents > 1) { if (change > 0) { changeEl.textContent = '▲'; changeEl.classList.add('up'); } else if (change < 0) { changeEl.textContent = '▼'; changeEl.classList.add('down'); } else { changeEl.textContent = '▬'; changeEl.classList.add('same'); } } else { changeEl.textContent = '●'; changeEl.classList.add('up');} clone.querySelector('[data-rank]').textContent = currentPos; clone.querySelector('[data-img]').src = driver.imageUrl; clone.querySelector('[data-name]').textContent = driver.name; clone.querySelector('[data-sub-name]').textContent = team.name; clone.querySelector('[data-team-bar]').className = `team-color-bar ${team.className}`; clone.querySelector('[data-score]').textContent = driverData.finalScore.toFixed(2); clone.querySelector('[data-score-bar]').style.width = `${driverData.finalScore}%`; const kpiContainer = clone.querySelector('[data-kpi-icons]'); const lastRaceKpis = raceEvents[totalRaceEvents - 1]?.kpis; if (lastRaceKpis) { if (lastRaceKpis.pole === driverData.id) kpiContainer.innerHTML += `<span class="kpi-icon pole" title="Pole Position">P</span>`; if (lastRaceKpis.fastestLap === driverData.id) kpiContainer.innerHTML += `<span class="kpi-icon fastest-lap" title="Fastest Lap">F</span>`; if (lastRaceKpis.biggestClimber?.id === driverData.id) kpiContainer.innerHTML += `<span class="kpi-icon overtakes" title="Biggest Climber">C</span>`; if (lastRaceKpis.driverOfTheDay === driverData.id) itemEl.classList.add('dotd'); } const history = driverHistory[driverData.id]; if (history && history.length >= 2) { const streak = getFormStreak(history); if (streak.count >= 2) { const streakEl = clone.querySelector('[data-streak]'); streakEl.textContent = streak.type === 'up' ? '🔥' : '❄️'; streakEl.title = `${streak.count} races in a row ${streak.type === 'up' ? 'climbing' : 'falling'}`; } } container.appendChild(clone); }); }
            function renderTeamList() { const container = document.getElementById('team-rankings-list'); const template = document.getElementById('team-ranking-item-template'); const prevPosMap = previousTeamRankings ? new Map(previousTeamRankings.map((t, i) => [t.id, i + 1])) : new Map(); container.innerHTML = ''; currentTeamRankings.forEach((teamData, index) => { if(teamData.driverScores.length === 0) return; const team = db.teams[teamData.id]; const clone = template.content.cloneNode(true); const itemEl = clone.querySelector('.ranking-item'); itemEl.dataset.teamId = teamData.id; const currentPos = index + 1; const previousPos = prevPosMap.get(teamData.id) || 11; const change = previousPos - currentPos; const changeEl = clone.querySelector('[data-change]'); if (totalRaceEvents > 1) { if (change > 0) { changeEl.textContent = '▲'; changeEl.classList.add('up'); } else if (change < 0) { changeEl.textContent = '▼'; changeEl.classList.add('down'); } else { changeEl.textContent = '▬'; changeEl.classList.add('same'); } } else { changeEl.textContent = '●'; changeEl.classList.add('up');} clone.querySelector('[data-rank]').textContent = currentPos; clone.querySelector('[data-img]').src = team.logoUrl; clone.querySelector('[data-name]').textContent = team.name; clone.querySelector('[data-score]').textContent = teamData.finalScore.toFixed(2); clone.querySelector('[data-score-bar]').style.width = `${teamData.finalScore}%`; const history = teamHistory[teamData.id]; if (history && history.length >= 2) { const streak = getFormStreak(history); if (streak.count >= 2) { const streakEl = clone.querySelector('[data-streak]'); streakEl.textContent = streak.type === 'up' ? '🔥' : '❄️'; streakEl.title = `${streak.count} races in a row ${streak.type === 'up' ? 'climbing' : 'falling'}`; } } container.appendChild(clone); }); }
            function renderMoversShakers() { if (totalRaceEvents === 0) return; const sortedByGain = [...cumulativeGainsData].sort((a,b) => b.netGain - a.netGain); const climber = sortedByGain[0]; const faller = sortedByGain[sortedByGain.length - 1]; if (climber && climber.netGain > 0) { const driver = db.drivers[climber.id]; const el = document.getElementById('biggest-climber'); el.querySelector('img').src = driver.imageUrl; el.querySelector('.mover-name').textContent = driver.name; el.querySelector('.mover-change').textContent = `▲${climber.netGain}`; } if (faller && faller.netGain < 0) { const driver = db.drivers[faller.id]; const el = document.getElementById('biggest-faller'); el.querySelector('img').src = driver.imageUrl; el.querySelector('.mover-name').textContent = driver.name; el.querySelector('.mover-change').textContent = `▼${Math.abs(faller.netGain)}`; } }
            function getFormStreak(historyArray) { if (historyArray.length < 2) return { type: 'none', count: 0 }; const trend = historyArray[historyArray.length - 1] < historyArray[historyArray.length - 2] ? 'up' : 'down'; let count = 1; for (let i = historyArray.length - 2; i > 0; i--) { if ((historyArray[i] < historyArray[i - 1] ? 'up' : 'down') === trend) { count++; } else break; } return { type: trend, count }; }

            function setupTabs() { const driverBtn = document.getElementById('show-drivers-rankings-btn'); const teamBtn = document.getElementById('show-teams-rankings-btn'); const driverView = document.getElementById('driver-rankings-view'); const teamView = document.getElementById('team-rankings-view'); driverBtn.addEventListener('click', () => { driverView.style.display = 'block'; teamView.style.display = 'none'; driverBtn.classList.add('active'); teamBtn.classList.remove('active'); }); teamBtn.addEventListener('click', () => { driverView.style.display = 'none'; teamView.style.display = 'block'; teamBtn.classList.add('active'); driverBtn.classList.remove('active'); }); }
            function setupModal() { const modal = document.getElementById('details-modal'); document.getElementById('modal-close-btn-details').addEventListener('click', () => { modal.style.display = 'none'; }); modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; }); document.getElementById('driver-rankings-list').addEventListener('click', (e) => { const item = e.target.closest('.ranking-item'); if (item?.dataset.driverId) openDetailsModal('driver', item.dataset.driverId); }); document.getElementById('team-rankings-list').addEventListener('click', (e) => { const item = e.target.closest('.ranking-item'); if (item?.dataset.teamId) openDetailsModal('team', item.dataset.teamId); }); }
            function openDetailsModal(type, id) { const isDriver = type === 'driver'; const entityData = isDriver ? currentDriverRankings.find(d => d.id === id) : currentTeamRankings.find(t => t.id === id); const entityInfo = isDriver ? db.drivers[id] : db.teams[id]; const history = isDriver ? driverHistory[id] : teamHistory[id]; document.getElementById('modal-name').textContent = entityInfo.name; document.getElementById('modal-img').src = isDriver ? entityInfo.imageUrl : entityInfo.logoUrl; document.getElementById('modal-img').className = isDriver ? 'driver-photo-rank' : 'team-logo-rank'; document.getElementById('modal-sub-name').textContent = isDriver ? db.teams[entityInfo.teamId].name : 'Formula 1 Team'; const breakdownContainer = document.getElementById('modal-score-breakdown'); breakdownContainer.innerHTML = Object.entries(entityData.breakdown).map(([key, value]) => `<div class="breakdown-item"><span>${key.charAt(0).toUpperCase() + key.slice(1)}</span><div class="breakdown-bar-container"><div class="breakdown-bar" style="width: ${value.toFixed(1)}%"></div></div><span>${value.toFixed(1)}</span></div>`).join(''); const h2hSection = document.getElementById('modal-h2h-section'); h2hSection.style.display = isDriver ? 'block' : 'none'; if (isDriver) populateH2H(id, entityInfo.teamId); drawChart(raceEvents.map(e => e.shortName), history); document.getElementById('details-modal').style.display = 'flex'; }
            
            // --- *** CORRECTED H2H LOGIC *** ---
            function populateH2H(driverId, teamId) {
                const teammateId = Object.keys(db.drivers).find(id => db.drivers[id].teamId === teamId && id !== driverId);
                const container = document.getElementById('modal-h2h-comparison');
                if (!teammateId) { container.innerHTML = 'No teammate data available.'; return; }

                let qualiWins = 0, raceWins = 0, racesContested = 0;
                raceEvents.forEach(event => {
                    const qualiRes = event.sessions.find(s => s.type === 'qualifying')?.results || [];
                    const raceRes = event.sessions.find(s => s.type === 'race')?.results || [];
                    const dQP = parseInt(qualiRes.find(r => r.driverId === driverId)?.pos);
                    const tQP = parseInt(qualiRes.find(r => r.driverId === teammateId)?.pos);
                    const dRP = parseInt(raceRes.find(r => r.driverId === driverId)?.pos);
                    const tRP = parseInt(raceRes.find(r => r.driverId === teammateId)?.pos);
                    
                    if (dQP && tQP) {
                        if (dQP < tQP) qualiWins++;
                    }
                    if (dRP && tRP) { 
                        racesContested++; 
                        if (dRP < tRP) raceWins++; 
                    }
                });

                container.innerHTML = `
                    <div class="h2h-item"><span>Qualifying</span><span>${qualiWins} - ${totalRaceEvents - qualiWins}</span></div>
                    <div class="h2h-item"><span>Race</span><span>${raceWins} - ${racesContested - raceWins}</span></div>
                    <small>vs ${db.drivers[teammateId].name}</small>`;
            }

            function drawChart(labels, data) { const ctx = document.getElementById('performance-chart').getContext('2d'); if (performanceChart) performanceChart.destroy(); performanceChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Ranking Position', data, backgroundColor: 'rgba(225, 6, 0, 0.2)', borderColor: 'rgba(225, 6, 0, 1)', borderWidth: 2, pointBackgroundColor: '#fff', pointBorderColor: 'rgba(225, 6, 0, 1)', pointHoverRadius: 7, pointRadius: 5, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { reverse: true, min: 1, max: 20, ticks: { color: '#A0A0A0', stepSize: 2 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#A0A0A0' }, grid: { display: false } } }, plugins: { legend: { display: false } } } }); }

            function setupCumulativeModal() {
                const modal = document.getElementById('cumulative-stats-modal');
                document.getElementById('modal-close-btn-cumulative').addEventListener('click', () => { modal.style.display = 'none'; });
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
                document.querySelector('[data-action="show-climbers"]').addEventListener('click', () => openCumulativeModal('climbers'));
                document.querySelector('[data-action="show-fallers"]').addEventListener('click', () => openCumulativeModal('fallers'));
            }

            function openCumulativeModal(sortBy) {
                const modal = document.getElementById('cumulative-stats-modal');
                const titleEl = document.getElementById('cumulative-modal-title');
                const listEl = document.getElementById('cumulative-modal-list');
                const template = document.getElementById('cumulative-stat-item-template');
                listEl.innerHTML = '';

                const sortedData = [...cumulativeGainsData].sort((a,b) => 
                    sortBy === 'climbers' ? b.netGain - a.netGain : a.netGain - b.netGain
                );

                titleEl.textContent = sortBy === 'climbers' ? "Season Position Gains" : "Season Position Losses";

                sortedData.forEach((stat, index) => {
                    const driver = db.drivers[stat.id];
                    const clone = template.content.cloneNode(true);

                    clone.querySelector('[data-rank]').textContent = index + 1;
                    clone.querySelector('[data-img]').src = driver.imageUrl;
                    clone.querySelector('[data-name]').textContent = driver.name;
                    
                    const changeEl = clone.querySelector('[data-change]');
                    if (stat.netGain > 0) {
                        changeEl.textContent = `▲ +${stat.netGain}`;
                        changeEl.classList.add('up');
                    } else if (stat.netGain < 0) {
                        changeEl.textContent = `▼ ${stat.netGain}`;
                        changeEl.classList.add('down');
                    } else {
                        changeEl.textContent = `▬ ${stat.netGain}`;
                        changeEl.classList.add('same');
                    }
                    listEl.appendChild(clone);
                });

                modal.style.display = 'flex';
            }

            // --- INITIALIZE APP ---
            renderAll();
            setupTabs();
            setupModal();
            setupCumulativeModal();
        });
    </script>
</body>
</html>